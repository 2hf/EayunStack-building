From 986ad1cb248f6c5893cef3b05f5cbe1f35f50397 Mon Sep 17 00:00:00 2001
From: Hunt Xu <mhuntxu@gmail.com>
Date: Thu, 7 Sep 2017 18:55:26 +0800
Subject: [PATCH 102/112] loadbalancer: fix filter condition when getting vip
 port

Fixes: redmine #10882

Signed-off-by: Hunt Xu <mhuntxu@gmail.com>
---
 neutron/db/loadbalancer/loadbalancer_db.py | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/neutron/db/loadbalancer/loadbalancer_db.py b/neutron/db/loadbalancer/loadbalancer_db.py
index 1b2a368a6..6ce32e00f 100644
--- a/neutron/db/loadbalancer/loadbalancer_db.py
+++ b/neutron/db/loadbalancer/loadbalancer_db.py
@@ -421,8 +421,9 @@ class LoadBalancerPluginDb(loadbalancer.LoadBalancerPluginBase,
             sess_qry = context.session.query(SessionPersistence)
             sess_qry.filter_by(vip_id=vip_id).delete()
 
-    def _vip_port_has_exist(self, context, vip_db, ip_addr):
-        port_filter = {'fixed_ips': {'ip_address': [ip_addr]}}
+    def _vip_port_has_exist(self, context, vip_db, fixed_ip):
+        port_filter = {'fixed_ips': {'ip_address': [fixed_ip['ip_address']],
+                                     'subnet_id': [fixed_ip['subnet_id']]}}
 
         ports = self._core_plugin.get_ports(context, filters=port_filter)
         if ports:
@@ -447,7 +448,7 @@ class LoadBalancerPluginDb(loadbalancer.LoadBalancerPluginBase,
         if ip_address and ip_address != attributes.ATTR_NOT_SPECIFIED:
             fixed_ip['ip_address'] = ip_address
             # check if vip port has exist
-            port = self._vip_port_has_exist(context, vip_db, ip_address)
+            port = self._vip_port_has_exist(context, vip_db, fixed_ip)
             if port:
                 need_create_port = False
 
-- 
2.11.0 (Apple Git-81)

